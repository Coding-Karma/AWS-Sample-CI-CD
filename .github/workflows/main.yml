name: Build, Sign and Deploy to EC2

on:
  workflow_dispatch: {}

permissions:
  id-token: write        # REQUIRED for keyless Cosign
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout source
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ AWS auth via OIDC (NO SECRETS)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::014780801274:role/CI
          aws-region: eu-north-1

      # 3Ô∏è‚É£ Login to Amazon ECR
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password \
          | docker login \
            --username AWS \
            --password-stdin 014780801274.dkr.ecr.eu-north-1.amazonaws.com

      # 4Ô∏è‚É£ Build image (tag = git commit SHA)
      - name: Build Docker image
        run: |
          docker build -t secure-app:${{ github.sha }} .

      # 5Ô∏è‚É£ Push image to ECR
      - name: Push Docker image
        run: |
          docker tag secure-app:${{ github.sha }} \
            014780801274.dkr.ecr.eu-north-1.amazonaws.com/secure-app:${{ github.sha }}

          docker push \
            014780801274.dkr.ecr.eu-north-1.amazonaws.com/secure-app:${{ github.sha }}

      # 6Ô∏è‚É£ Install Cosign
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      # 7Ô∏è‚É£ Install Rekor CLI (OPTION 1)
      - name: Install Rekor CLI
        run: |
          curl -sSL https://github.com/sigstore/rekor/releases/latest/download/rekor-linux-amd64 \
            -o rekor-cli
          chmod +x rekor-cli
          sudo mv rekor-cli /usr/local/bin/rekor-cli

      # 8Ô∏è‚É£ Sign image (KEYLESS + REKOR GUARANTEED)
      - name: Sign image with Cosign
        env:
          COSIGN_EXPERIMENTAL: "true"
          COSIGN_YES: "true"       # üî¥ CRITICAL: forces Rekor upload
        run: |
          cosign sign \
            014780801274.dkr.ecr.eu-north-1.amazonaws.com/secure-app:${{ github.sha }}

      # 9Ô∏è‚É£ Resolve immutable digest AFTER signing
      - name: Resolve image digest
        run: |
          DIGEST=$(aws ecr describe-images \
            --repository-name secure-app \
            --region eu-north-1 \
            --image-ids imageTag=${{ github.sha }} \
            --query 'imageDetails[0].imageDigest' \
            --output text)

          echo "IMAGE_DIGEST=$DIGEST" >> $GITHUB_ENV
          echo "Resolved digest: $DIGEST"

      # üîü Verify Rekor transparency log entry (PROOF)
      - name: Verify Rekor transparency log
        run: |
          rekor-cli search \
            --artifact 014780801274.dkr.ecr.eu-north-1.amazonaws.com/secure-app@${IMAGE_DIGEST}

      # 1Ô∏è‚É£1Ô∏è‚É£ Write EC2 user-data (pull by DIGEST)
      - name: Write EC2 user-data
        run: |
          printf '%s\n' \
          '#!/bin/bash' \
          'yum update -y' \
          'amazon-linux-extras install docker -y' \
          'systemctl start docker' \
          'systemctl enable docker' \
          'aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin 014780801274.dkr.ecr.eu-north-1.amazonaws.com' \
          "docker run -d -p 80:5000 014780801274.dkr.ecr.eu-north-1.amazonaws.com/secure-app@${IMAGE_DIGEST}" \
          > ec2-user-data.sh

      # 1Ô∏è‚É£2Ô∏è‚É£ Launch EC2 instance
      - name: Launch EC2 instance
        run: |
          AMI_ID=$(aws ec2 describe-images \
            --owners amazon \
            --filters Name=name,Values=amzn2-ami-hvm-*-x86_64-gp2 Name=state,Values=available \
            --query 'Images | sort_by(@, &CreationDate) | [-1].ImageId' \
            --output text)

          aws ec2 run-instances \
            --image-id "$AMI_ID" \
            --instance-type t3.micro \
            --key-name ec2-debug-key \
            --iam-instance-profile Name=EC2-ECR-Pull \
            --security-group-ids sg-0e2975f330f66f9e2 \
            --subnet-id subnet-00d6528964bbc421a \
            --associate-public-ip-address \
            --user-data file://ec2-user-data.sh
